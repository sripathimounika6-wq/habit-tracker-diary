<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Daily Diary — Habit & Diary Tracker</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f172a;
      --panel:#0b1220;
      --muted:#94a3b8;
      --accent:#ff7ab6;
      --accent2:#7c3aed;
      --card:#071128;
      --success:#10b981;
      --glass: rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box}
    body{font-family:Poppins,Inter,Arial, sans-serif;margin:0;background:linear-gradient(180deg,var(--bg),#071024);color:#e6eef8;padding:2rem;}
    .wrap{max-width:960px;margin:0 auto}
    header{display:flex;justify-content:space-between;align-items:center;gap:1rem;margin-bottom:1rem}
    h1{margin:0;font-size:1.6rem;letter-spacing:-0.4px;color:var(--accent)}
    .subtitle{color:var(--muted);font-size:0.95rem}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:14px;padding:1rem;border:1px solid rgba(255,255,255,0.03); margin-bottom:1rem}
    .row{display:flex;gap:0.6rem;align-items:center}
    input,select,textarea,button{padding:0.6rem 0.8rem;border-radius:10px;border:none;background:var(--glass);color:inherit}
    input[type="date"]{padding:0.5rem}
    .title{font-weight:600}
    .btn{cursor:pointer;border-radius:10px;padding:0.55rem 0.9rem}
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:white}
    .entry{display:flex;justify-content:space-between;align-items:center;padding:0.8rem;border-radius:10px;margin-bottom:0.6rem;background:linear-gradient(90deg, rgba(124,58,237,0.06), rgba(255,122,182,0.03))}
    .left{display:flex;gap:0.8rem;align-items:center}
    .meta{color:var(--muted);font-size:0.9rem}
    .controls{display:flex;gap:0.4rem}
    .note{font-size:0.9rem;color:#cfe8ff;margin-top:0.4rem}
    .empty{color:var(--muted)}
    @media (max-width:640px){.row{flex-direction:column;align-items:stretch}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Daily Diary</h1>
        <div class="subtitle">Track habits and diary entries — check them done, add notes and a date.</div>
      </div>
      <div class="meta">Status: <span id="status">loading</span></div>
    </header>

    <div class="card">
      <div class="row">
        <input id="title" placeholder="Title (e.g. Morning run)" style="flex:1" />
        <input id="date" type="date" style="width:140px" />
        <select id="frequency"><option value="daily">Daily</option><option value="weekly">Weekly</option><option value="one-off">One-off</option></select>
      </div>
      <div style="margin-top:0.6rem">
        <textarea id="notes" placeholder="Notes (optional)" style="width:100%;min-height:70px;border-radius:10px;padding:0.6rem"></textarea>
      </div>
      <div style="margin-top:0.6rem;display:flex;justify-content:space-between;align-items:center">
        <div class="small muted">Quick diary entry + habit tracking</div>
        <div>
          <button id="create" class="btn primary">Add Entry</button>
          <button id="clear" class="btn" style="margin-left:0.5rem">Clear My Data</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 0.6rem 0">Entries</h2>
      <div id="list"><div class="empty">Loading...</div></div>
    </div>
  </div>

  <script>
  const api = '/api/habits';
  function uid(){
    let id = localStorage.getItem('habit_user_id');
    if(!id){ id = 'u_' + (crypto && crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(36)); localStorage.setItem('habit_user_id', id); }
    return id;
  }
  const USER_ID = uid();
  const statusEl = document.getElementById('status');
  function setStatus(s){ statusEl.innerText = s; }

  async function apiCall(path, opts={}){
    opts.headers = opts.headers || {};
    opts.headers['X-User-Id'] = USER_ID;
    if(opts.body && typeof opts.body === 'object'){
      opts.body = JSON.stringify(opts.body);
      opts.headers['Content-Type'] = 'application/json';
    }
    const res = await fetch(path, opts);
    if(!res.ok){
      const txt = await res.text();
      throw new Error(res.status + ' ' + txt);
    }
    return res.json();
  }

  function fmtDate(ts){
         const d=new Date(ts*1000); return Number.isNaN(d.getTime()) ? '' : d.toLocaleString();
}

  async function load(){
    setStatus('loading');
    try{
      const items = await apiCall(api, {method:'GET'});
      render(items || []);
      setStatus('ready');
    }catch(err){ setStatus('offline'); document.getElementById('list').innerHTML = '<div class="empty">Unable to load: '+err.message+'</div>'; }
  }

  function render(items){
    const list = document.getElementById('list'); list.innerHTML='';
    if(!items || items.length===0){ list.innerHTML = '<div class="empty">No entries yet — add your first diary entry.</div>'; return; }
    items.forEach(h=>{
      const el = document.createElement('div'); el.className='entry';
      el.innerHTML = `<div class="left">
        <input type="checkbox" ${h.done ? 'checked' : ''} onchange="toggleDone('${h.id}', this.checked)" />
        <div>
          <div style="font-weight:700">${escape(h.title)}</div>
          <div class="meta">${h.date ? escape(h.date) + ' · ' : ''}${h.frequency || ''} · ${fmtDate(h.created_at)}</div>
          ${h.notes ? '<div class="note">'+escape(h.notes)+'</div>' : ''}
        </div>
      </div>
      <div class="controls">
        <button onclick="editEntry('${h.id}', '${escapeAttr(h.title)}')">Edit</button>
        <button onclick="deleteEntry('${h.id}')">Delete</button>
      </div>`;
      list.appendChild(el);
    });
  }

  function escape(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
  function escapeAttr(s){ return String(s).replaceAll("'","\\"); }

  async function toggleDone(id, done){
    try{
      await apiCall(api + '/' + id, {method:'PUT', body:{done:done}});
      await load();
    }catch(err){ alert('Toggle failed: '+err.message); }
  }

  async function deleteEntry(id){
    if(!confirm('Delete this entry?')) return;
    try{ await apiCall(api + '/' + id, {method:'DELETE'}); await load(); }catch(e){ alert('Delete failed: '+e.message); }
  }

  async function editEntry(id, oldTitle){
    const title = prompt('New title', oldTitle);
    if(!title) return;
    const notes = prompt('Notes (leave blank to keep)', '');
    try{ await apiCall(api + '/' + id, {method:'PUT', body:{title, notes}}); await load(); }catch(e){ alert('Update failed:'+e.message); }
  }

  document.getElementById('create').onclick = async ()=>{
    const title = document.getElementById('title').value.trim();
    const date = document.getElementById('date').value || null;
    const frequency = document.getElementById('frequency').value;
    const notes = document.getElementById('notes').value.trim() || null;
    if(!title){ alert('Enter a title'); return; }
    try{
      await apiCall(api, {method:'POST', body:{title, date, frequency, notes}});
      document.getElementById('title').value=''; document.getElementById('notes').value=''; document.getElementById('date').value='';
      await load();
    }catch(e){ alert('Create failed: '+e.message); }
  }

  document.getElementById('clear').onclick = async ()=>{
    if(!confirm('Clear your browser id and server data?')) return;
    localStorage.removeItem('habit_user_id');
    try{
      const items = await apiCall(api, {method:'GET'});
      for(const it of items){ await apiCall(api + '/' + it.id, {method:'DELETE'}); }
      alert('Cleared.');
      globalThis.location.reload();
    }catch(e){ alert('Clear failed: '+e.message); }
  }

  load();
  </script>
</body>
</html>
